name: contracts-go

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
    tags:
      - 'v*.*.*'

jobs:
  lint_and_test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: bufbuild/buf-setup-action@v1
      - name: Lint proto files
        run: buf lint
      - name: Check breaking changes
        run: buf breaking --against '.git#branch=main' || true

  preview_on_pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    needs: lint_and_test
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: bufbuild/buf-setup-action@v1
      - name: Generate Go code
        run: buf generate
      - name: Push to contracts-go PR branch
        env:
          PUSH_TOKEN: ${{ secrets.ORG_PUSH_TOKEN }}
        run: |
          CONTRACTS_DIR=$(mktemp -d)
          git clone "https://x-access-token:${PUSH_TOKEN}@github.com/bookingcontrol/booker-contracts-go.git" "$CONTRACTS_DIR" || \
            (echo "Repository booker-contracts-go not found. Create it first." && exit 1)
          
          # Copy generated code, excluding .git and .github
          rsync -a --delete \
            --exclude ".git" \
            --exclude ".github" \
            "${{ github.workspace }}/gen/go/" "$CONTRACTS_DIR/"
          
          cd "$CONTRACTS_DIR"
          
          # Create/update go.mod if it doesn't exist
          if [ ! -f go.mod ]; then
            printf 'module github.com/bookingcontrol/booker-contracts-go/v1\n\n' > go.mod
            printf 'go 1.23.0\n\n' >> go.mod
            printf 'require (\n' >> go.mod
            printf '\tgoogle.golang.org/grpc v1.69.2\n' >> go.mod
            printf '\tgoogle.golang.org/protobuf v1.36.8\n' >> go.mod
            printf ')\n' >> go.mod
          fi
          
          git config user.name "bookingcontrol-bot"
          git config user.email "bot@users.noreply.github.com"
          
          BRANCH="pr/${{ github.event.pull_request.number }}"
          git checkout -B "$BRANCH"
          git add -A
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "gen: PR #${{ github.event.pull_request.number }} from booker-contracts"
            git push "https://x-access-token:${PUSH_TOKEN}@github.com/bookingcontrol/booker-contracts-go.git" "$BRANCH" --force
          fi
      
      - name: Create prerelease tag
        env:
          PUSH_TOKEN: ${{ secrets.ORG_PUSH_TOKEN }}
        run: |
          CDIR=$(mktemp -d)
          git clone "https://x-access-token:${PUSH_TOKEN}@github.com/bookingcontrol/booker-contracts-go.git" "$CDIR" || exit 1
          
          cd "$CDIR"
          git config user.name "bookingcontrol-bot"
          git config user.email "bot@users.noreply.github.com"
          
          PR="pr.${{ github.event.pull_request.number }}"
          TAG="v0.0.0-${PR}"
          
          git checkout -B "pr/${{ github.event.pull_request.number }}" || git checkout "pr/${{ github.event.pull_request.number }}"
          git tag -f "$TAG" || git tag "$TAG"
          git push "https://x-access-token:${PUSH_TOKEN}@github.com/bookingcontrol/booker-contracts-go.git" "$TAG" --force

  release_on_tag:
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: bufbuild/buf-setup-action@v1
      - name: Generate Go code
        run: buf generate
      - name: Sync to contracts-go and tag
        env:
          TAG: ${{ github.ref_name }}
          PUSH_TOKEN: ${{ secrets.ORG_PUSH_TOKEN }}
          GH_TOKEN: ${{ secrets.ORG_PUSH_TOKEN }}
        run: |
          CONTRACTS_DIR=$(mktemp -d)
          echo "Cloning to: $CONTRACTS_DIR"
          
          # Clone using PAT
          git clone "https://x-access-token:${PUSH_TOKEN}@github.com/bookingcontrol/booker-contracts-go.git" "$CONTRACTS_DIR" || \
            (echo "Repository booker-contracts-go not found. Create it first." && exit 1)
          
          # Copy generated code, excluding .git and .github
          rsync -a --delete \
            --exclude ".git" \
            --exclude ".github" \
            "${{ github.workspace }}/gen/go/" "$CONTRACTS_DIR/"
          
          cd "$CONTRACTS_DIR"
          
          # Create/update go.mod if it doesn't exist
          if [ ! -f go.mod ]; then
            printf 'module github.com/bookingcontrol/booker-contracts-go/v1\n\n' > go.mod
            printf 'go 1.23.0\n\n' >> go.mod
            printf 'require (\n' >> go.mod
            printf '\tgoogle.golang.org/grpc v1.69.2\n' >> go.mod
            printf '\tgoogle.golang.org/protobuf v1.36.8\n' >> go.mod
            printf ')\n' >> go.mod
          fi
          
          git config user.name "bookingcontrol-bot"
          git config user.email "bot@users.noreply.github.com"
          
          git add -A
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "gen: release $TAG from booker-contracts"
          fi
          
          git tag -f "$TAG" || git tag "$TAG"
          
          # Push using PAT
          git push "https://x-access-token:${PUSH_TOKEN}@github.com/bookingcontrol/booker-contracts-go.git" HEAD
          git push "https://x-access-token:${PUSH_TOKEN}@github.com/bookingcontrol/booker-contracts-go.git" "$TAG" --force
          
          # Create GitHub Release (gh CLI использует GH_TOKEN из env)
          gh release create "$TAG" \
            --repo bookingcontrol/booker-contracts-go \
            --title "Release $TAG" \
            --notes "Generated from booker-contracts tag $TAG" || \
            gh release edit "$TAG" \
              --repo bookingcontrol/booker-contracts-go \
              --title "Release $TAG" \
              --notes "Generated from booker-contracts tag $TAG"

