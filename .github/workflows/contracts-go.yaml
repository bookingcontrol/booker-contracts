name: contracts-go

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
    tags:
      - 'v*.*.*'

jobs:
  lint_and_test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: bufbuild/buf-setup-action@v1
      - name: Lint proto files
        run: buf lint
      - name: Check breaking changes
        run: buf breaking --against '.git#branch=main' || true

  preview_on_pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    needs: lint_and_test
    permissions:
      contents: write
      packages: write
      repository-projects: write
    steps:
      - uses: actions/checkout@v4
      - uses: bufbuild/buf-setup-action@v1
      - name: Generate Go code
        run: buf generate
      - name: Push to contracts-go PR branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CONTRACTS_DIR=$(mktemp -d)
          git -c credential.helper= \
            -c credential.helper='!f() { echo "username=x-access-token"; echo "password=$GITHUB_TOKEN"; }; f' \
            clone https://github.com/bookingcontrol/booker-contracts-go.git "$CONTRACTS_DIR" || \
            (echo "Repository booker-contracts-go not found. Create it first." && exit 1)
          
          rsync -a --delete gen/go/ "$CONTRACTS_DIR/"
          
          cd "$CONTRACTS_DIR"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          BRANCH="pr/${{ github.event.pull_request.number }}"
          git checkout -B "$BRANCH"
          git add -A
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "gen: PR #${{ github.event.pull_request.number }} from booker-contracts"
            git -c credential.helper= \
              -c credential.helper='!f() { echo "username=x-access-token"; echo "password=$GITHUB_TOKEN"; }; f' \
              push origin "$BRANCH" --force
          fi
      
      - name: Create prerelease tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CDIR=$(mktemp -d)
          git -c credential.helper= \
            -c credential.helper='!f() { echo "username=x-access-token"; echo "password=$GITHUB_TOKEN"; }; f' \
            clone https://github.com/bookingcontrol/booker-contracts-go.git "$CDIR" || exit 1
          
          cd "$CDIR"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          PR="pr.${{ github.event.pull_request.number }}"
          TAG="v0.0.0-${PR}"
          
          git checkout -B "pr/${{ github.event.pull_request.number }}" || git checkout "pr/${{ github.event.pull_request.number }}"
          git tag -f "$TAG" || git tag "$TAG"
          git -c credential.helper= \
            -c credential.helper='!f() { echo "username=x-access-token"; echo "password=$GITHUB_TOKEN"; }; f' \
            push origin "$TAG" --force

  release_on_tag:
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      repository-projects: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: bufbuild/buf-setup-action@v1
      - name: Generate Go code
        run: buf generate
      - name: Sync to contracts-go and tag
        env:
          TAG: ${{ github.ref_name }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CONTRACTS_DIR=$(mktemp -d)
          
          # Clone using GITHUB_TOKEN
          git -c credential.helper= \
            -c credential.helper='!f() { echo "username=x-access-token"; echo "password=$GITHUB_TOKEN"; }; f' \
            clone https://github.com/bookingcontrol/booker-contracts-go.git "$CONTRACTS_DIR" || \
            (echo "Repository booker-contracts-go not found. Create it first." && exit 1)
          
          rsync -a --delete gen/go/ "$CONTRACTS_DIR/"
          
          cd "$CONTRACTS_DIR"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add -A
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "gen: release $TAG from booker-contracts"
          fi
          
          git tag -f "$TAG" || git tag "$TAG"
          
          # Push using credential helper
          git -c credential.helper= \
            -c credential.helper='!f() { echo "username=x-access-token"; echo "password=$GITHUB_TOKEN"; }; f' \
            push origin HEAD
          
          git -c credential.helper= \
            -c credential.helper='!f() { echo "username=x-access-token"; echo "password=$GITHUB_TOKEN"; }; f' \
            push origin "$TAG" --force
          
          # Create GitHub Release
          export GITHUB_TOKEN="${{ secrets.GITHUB_TOKEN }}"
          gh release create "$TAG" \
            --repo bookingcontrol/booker-contracts-go \
            --title "Release $TAG" \
            --notes "Generated from booker-contracts tag $TAG" || \
            gh release edit "$TAG" \
              --repo bookingcontrol/booker-contracts-go \
              --title "Release $TAG" \
              --notes "Generated from booker-contracts tag $TAG"

